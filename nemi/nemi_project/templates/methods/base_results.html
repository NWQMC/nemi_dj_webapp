{% extends "base.html" %}

{% block title %}NEMI Results{% endblock %}

{% block page_style %}
	<link rel="stylesheet" href="{{ STATIC_URL }}styles/tablesort/theme.nemi.css" media="screen" type="text/css" />
	<link rel="stylesheet" href="{{ STATIC_URL }}styles/jquery-ui-1.10.0.custom/smoothness/jquery-ui-1.10.0.custom.css" media="screen" type="text/css" />
{% endblock %}

{% block page_script %}
	<script src="{{ STATIC_URL }}script/jquery_tablesorter/jquery.tablesorter.js"></script>
	<script src="{{ STATIC_URL }}script/jquery_tablesorter/jquery.tablesorter.widgets.js"></script>
	<script src="{{ STATIC_URL }}script/jquery-ui/jquery-ui-1.10.0.custom.js"></script>
	<script src="{{ STATIC_URL }}script/Utils.js"></script>
	<script src="{{ STATIC_URL }}script/CustomHeaderDialog.js"></script>
	<script src="{{ STATIC_URL }}script/HelpDialog.js"></script>
	
	
	<script type="text/javascript">
		$(document).ready(function() {
			// Tried to use the stickyHeaders widget but when columns where added or remove
			// the header did not adjust as it should. Also tried to use 'resizable' which 
			// kept throwing errors down in the jquery tablesorter code.
			
			// The tables can be customized using meta data and class definitions
			// See the jquery tablesorter documentation.
			$('.data-table').tablesorter({
				theme: 'nemi',
				widgets: ['zebra']
			});
			

			$('#back-button').click(function() {
				window.location.assign("{% url 'home' %}");
			});
			
			// Find column headers with class hide-column and then hide those columns 
			$('.hide-column').each(function() {
				var colIndex = $(this).index() + 1;
				var tableEl = $(this).parents('table');
				
				$(this).hide();
				tableEl.find('tr td:nth-child(' + colIndex + ')').hide();
			});

			// Add code to limit visible results to selected rows if there 
			// is a compare button.
			$('.compare-button').click(function() {
				$('#results-table input[type=checkbox]').not(':checked').parents('tr').hide();
				var resort = true;
				$('.data-table').trigger('update', [resort]);
				Utils.setEnabled($('.full-results-button'), true);
			});
			
			// Add click handler for full results button.
			$('.full-results-button').click(function() {
				$('#results-table tr:hidden').show();
				$('#results-table input[type=checkbox]:checked').removeAttr('checked');
				Utils.setEnabled($('.full-results-button'), false);
				Utils.setEnabled($('.compare-button'), false);
				
			});
			
			// Add click handler for selecting methods to set the state of the operations buttons .
			$('#results-table input[type=checkbox]').click(function() {
				var compareBtn = $('.compare-button');
				if ($(this).is(':checked')) {
					Utils.setEnabled(compareBtn, true);
				}
				else {
					// Have to look at all visible checkboxes to see if any are set.
					if (!$('#results-table input[type=checkbox]:visible').is(':checked')) {
						Utils.setEnabled(compareBtn, false);
					}
				}
			});
			
			// Hook up download-button. Make it invisible if no export_url was 
			// passed to the template. 
			if ('{{ export_url }}' == ''){
				$('.download-button').hide();
			}
			else {
				$('.download-button').click(function() {
					// Get all visible method ids and put into a query parameter 
					var params = '{{ request.GET.urlencode }}';
					$('#results-table tbody tr:visible').each(function() {
						if (params != '') {
							params += '&';
						}
						params += 'method_id=' + $(this).attr('id')
					});
					window.open("{{ export_url }}?" + params);
					return false;
				});
			}
			
			// Initialize help dialog
			HelpDialog.initialize($('#header-info'));
			
			// Forces a click on the header information button to call it's link rather than perform 
			// the sort. We have to use mousedown mouseup because that's the event the tablesorter has bound an
			// event handler too.
			$('#results-table th a').bind('mousedown mouseup',function(event){
				event.stopPropagation();
				window.location=$(this).attr('href');
				return false;
			});
			
			// Initialize customize headers dialog and add click handler for button
			if ($('#customize_dialog')){
				CustomHeaderDialog.initialize($('#customize-dialog'), $('#results-table'));
				
				$('#customize-button').click(function() {
					CustomHeaderDialog.show();
				});
			}
		});
	</script>
{% endblock %}

{% block page_info %}
	<p>
		{% block page_specific_info %}
			Your search returned: {{ data|length }} results.
		{% endblock %}
		<input id="back-button" class="search-button" type="button" style="font-size: small;" value="Back to search">
	</p>
	{% block top_results_actions %}
		<div id="top-results-actions" class="results-actions">
			<input type="button" class="compare-button search-button disabled" disabled="disabled" value="Compare selected results" />
			<input type="button" class="full-results-button search-button disabled" disabled="disabled" value="Show full results" />
			<input type="button" class="download-button search-button" value="Download results"/>
		</div>
	{% endblock %}
{% endblock %}

{% block page-content %}
	<!--  Place holder for the field information dialog  -->
	<div id="header-info" style="display: none;">
	</div>
	<div id="results-div" class="section-div">
		<h2>
			{% block page_content_title%}
				RESULTS
			{% endblock %}
			
			{% block customize_dialog %}
				<div style="display: inline-block; float:right;">
					<input id="customize-button" type="button" class="search-button" style="font-size:small;position: relative; top: -3px;" value="Show/hide columns" />
				</div>
				<div id="customize-dialog" style="display: none;">
					<p>Select the fields you want to see in your results table:</p>
					<ul></ul>
				</div>
			{% endblock %}
		</h2>	
		
		{% block results_content %}
		{% endblock %}
		
		{% block bottom_results_actions %}
			<div id="bottom-results-actions" class="results-actions">
				<input type="button" class="compare-button search-button disabled" disabled="disabled" value="Compare selected results" />
				<input type="button" class="full-results-button search-button disabled" disabled="disabled" value="Show full results" />
				<input type="button" class="download-button search-button" value="Download results"/>
			</div>
		{% endblock %}

{% endblock %}	
	
