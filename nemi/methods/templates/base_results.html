{% extends "base.html" %}

{% block title %}NEMI Results{% endblock %}

{% block page_style %}
	<link rel="stylesheet" href="{{ STATIC_URL }}styles/tablesort/theme.nemi.css" media="screen" type="text/css" />
	<link rel="stylesheet" href="{{ STATIC_URL }}styles/jquery-ui-1.10.0.custom/smoothness/jquery-ui-1.10.0.custom.css" media="screen" type="text/css" />
{% endblock %}

{% block page_script %}
	<script src="{{ STATIC_URL }}script/jquery_tablesorter/jquery.tablesorter.js"></script>
	<script src="{{ STATIC_URL }}script/jquery_tablesorter/jquery.tablesorter.widgets.js"></script>
	<script src="{{ STATIC_URL }}script/jquery-ui/jquery-ui-1.10.0.custom.js"></script>
	<script src="{{ STATIC_URL }}script/CustomHeaderDialog.js"></script>
	<script type="text/javascript">
		// Set the disabled state and appearance of the jquery elements in els 
		function setEnabled(els /* jquery elements */, isEnabled /* Boolean */) {
			if (isEnabled) {
				els.removeAttr('disabled').removeClass('disabled');
			}
			else {
				els.attr('disabled', 'disabled').addClass('disabled');
			}
		}
		
		$(document).ready(function() {
			$('#back-button').click(function() {
				window.location.assign("{% url 'home' %}");
			});
			
			// Find column headers with class hide-column and then hide those columns 
			$('.hide-column').each(function() {
				var colIndex = $(this).index() + 1;
				var tableEl = $(this).parents('table');
				
				$(this).hide();
				tableEl.find('tr td:nth-child(' + colIndex + ')').hide();
			});

			// Add code to limit visible results to selected rows if there 
			// is a compare button.
			$('#compare-button').click(function() {
				$('input[type=checkbox]').not(':checked').parents('tr').hide();
				var resort = true;
				$('.data-table').trigger('update', [resort]);
				setEnabled($('#full-results-button'), true);
			});
			
			// Add click handler for full results button.
			$('#full-results-button').click(function() {
				$('tr:hidden').show();
				$('input[type=checkbox]:checked').removeAttr('checked');
				setEnabled($(this), false);
			});
			
			// Add click handler for selecting methods to set the state of the operations buttons .
			$('input[type=checkbox]').click(function() {
				var compareBtn = $('#compare-button');
				var downloadBtn = $('#download-button');
				if ($(this).is(':checked')) {
					setEnabled(compareBtn, true);
					setEnabled(downloadBtn, true);
				}
				else {
					// Have to look at all visible checkboxes to see if any are set.
					if (!$('input[type=checkbox]:visible').is(':checked')) {
						setEnabled(compareBtn, false);
						setEnabled(downloadBtn, false);
					}
				}
			});
			
			// Hook up download-button. Make it invisible if no export_url was 
			// passed to the template. 
			if ('{{ export_url }}' == ''){
				$('#download-button').hide();
			}
			else {
				$('#download-button').click(function() {
					// Get all visible method ids and put into a query parameter 
					var params = '{{ request.GET.urlencode }}';
					$('#results-table tbody tr:visible').each(function() {
						if (params != '') {
							params += '&';
						}
						params += 'method_id=' + $(this).attr('id')
					});
					window.open("{{ export_url }}?" + params);
					return false;
				});
			}
			
			// Tried to use the stickyHeaders widget but when columns where added or remove
			// the header did not adjust as it should. Also tried to use 'resizable' which 
			// kept throwing errors down in the jquery tablesorter code.
			
			// The tables can be customized using meta data and class definitions
			// See the jquery tablesorter documentation.
			$('.data-table').tablesorter({
				theme: 'nemi',
				widgets: ['zebra']
			});
			
			// Initialize customize headers dialog and add click handler for button
			if ($('#customize_dialog')){
				CustomHeaderDialog.initialize($('#customize-dialog'), $('#results-table'));
				
				$('#customize-button').click(function() {
					CustomHeaderDialog.show();
				});
			}
		});
	</script>
{% endblock %}

{% block page_info %}
	<p>
		{% block page_specific_info %}
			Your search returned: {{ data|length }} methods, protocols, or procedures.
		{% endblock %}
		<input id="back-button" class="search-button" type="button" style="font-size: small;" value="Back to search">
	</p>
{% endblock %}

{% block page-content %}
	<div id="results-div" class="section-div">
		<h2>
			{% block page_content_title%}
				RESULTS
			{% endblock %}
			
			{% block customize_dialog %}
				<div style="display: inline-block; float:right;">
					<input id="customize-button" type="button" class="search-button" style="font-size:small;position: relative; top: -3px;" value="CUSTOMIZE HEADER" />
				</div>
				<div id="customize-dialog" style="display: none;">
					<p>Select the fields you want to see in your results table:</p>
					<ul></ul>
				</div>
			{% endblock %}
		</h2>	
		
		{% block results_content %}
		{% endblock %}
		
		{% block results_actions %}
			<div id="results-actions">
				<input type="button" id="compare-button" class="search-button disabled" value="COMPARE SELECTED RESULTS" />
				<input type="button" id="full-results-button" class="search-button disabled" value="SHOW FULL RESULTS" />
				<input type="button" id="download-button" class="search-button" value="DOWNLOAD RESULTS" disabled="disabled"/>
			</div>
		{% endblock %}

{% endblock %}	
	
